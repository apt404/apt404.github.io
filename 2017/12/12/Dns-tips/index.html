<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 首先,我们先来简单回顾下DNS的基本解析流程, 比较简单,如下12345678910-&amp;gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找  -&amp;gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip">
<meta name="keywords" content="DNS 深度理解">
<meta property="og:type" content="article">
<meta property="og:title" content="DNS 深度理解 [ 一 ]">
<meta property="og:url" content="https://apt404.github.io/2017/12/12/Dns-tips/index.html">
<meta property="og:site_name" content="APT404-不疯不魔怎么活">
<meta property="og:description" content="0x01 首先,我们先来简单回顾下DNS的基本解析流程, 比较简单,如下12345678910-&amp;gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找  -&amp;gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://apt404.github.io/img/dns101.jpg">
<meta property="og:image" content="https://apt404.github.io/img/dns%20bind%20resolv.png">
<meta property="og:image" content="https://apt404.github.io/img/dns%20reverse%20resolv.png">
<meta property="og:image" content="https://apt404.github.io/img/dns%20MASTER%20MX.png">
<meta property="og:image" content="https://apt404.github.io/img/dns%20master%20ptr.png">
<meta property="og:image" content="https://apt404.github.io/img/dns%20zone%20vluln.png">
<meta property="og:updated_time" content="2017-12-30T12:47:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DNS 深度理解 [ 一 ]">
<meta name="twitter:description" content="0x01 首先,我们先来简单回顾下DNS的基本解析流程, 比较简单,如下12345678910-&amp;gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找  -&amp;gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip">
<meta name="twitter:image" content="https://apt404.github.io/img/dns101.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>DNS 深度理解 [ 一 ]</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/12/13/samba-sec/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/12/11/svn-config-sec/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://apt404.github.io/2017/12/12/Dns-tips/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://apt404.github.io/2017/12/12/Dns-tips/&text=DNS 深度理解 [ 一 ]"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://apt404.github.io/2017/12/12/Dns-tips/&is_video=false&description=DNS 深度理解 [ 一 ]"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DNS 深度理解 [ 一 ]&body=Check out this article: https://apt404.github.io/2017/12/12/Dns-tips/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://apt404.github.io/2017/12/12/Dns-tips/&name=DNS 深度理解 [ 一 ]&description=&lt;p&gt;0x01 首先,我们先来简单回顾下&lt;code&gt;DNS的基本解析流程&lt;/code&gt;, 比较简单,如下&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;-&amp;gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -&amp;gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -&amp;gt; 如果缓存中没有,则会向我们事先设置好的dns服务器 [ 一般有两个, 主 &amp;amp; 备 ] 去请求,即所谓的`递归查询`,dns服务器首先会到自身解析数据库中去查&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      -&amp;gt; 如果dns服务器在自己的解析库中也没找到,它就会自动帮我们向根发送询问请求&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	-&amp;gt; 此时,根看到要请求的是org的后缀,就会把org所在的ns服务器告诉我们的dns&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	  -&amp;gt; 然后,我们的dns服务器就会去请求org所在的ns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	    -&amp;gt; 当请求到达org ns服务器时,org一看域名是在rootkit这个域下的,就会把rootkit所在的ns服务器再告诉我们的dns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	       -&amp;gt; 再然后,我们的dns服务器就会去请求rootkit这个域的ns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		 -&amp;gt; rootkit这个域的ns服务器一看是要访问www就直接找到了www对应的A记录的ip,并把它丢给我们的dns,上面逐个询问的过程,即 `迭代查询`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		   -&amp;gt; 最后,我们的dns再把最终解析到的这个ip丢给我们的客户端,然后客户端就直接拿着去访问了,如下,访问google.com时的简易流程图&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        DNS 深度理解 [ 一 ]
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">klion</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-12-11T20:09:17.000Z" itemprop="datePublished">2017-12-12</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/DNS-深度理解/">DNS 深度理解</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>0x01 首先,我们先来简单回顾下<code>DNS的基本解析流程</code>, 比较简单,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找</span><br><span class="line">  -&gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip</span><br><span class="line">    -&gt; 如果缓存中没有,则会向我们事先设置好的dns服务器 [ 一般有两个, 主 &amp; 备 ] 去请求,即所谓的`递归查询`,dns服务器首先会到自身解析数据库中去查</span><br><span class="line">      -&gt; 如果dns服务器在自己的解析库中也没找到,它就会自动帮我们向根发送询问请求</span><br><span class="line">	-&gt; 此时,根看到要请求的是org的后缀,就会把org所在的ns服务器告诉我们的dns</span><br><span class="line">	  -&gt; 然后,我们的dns服务器就会去请求org所在的ns服务器</span><br><span class="line">	    -&gt; 当请求到达org ns服务器时,org一看域名是在rootkit这个域下的,就会把rootkit所在的ns服务器再告诉我们的dns服务器</span><br><span class="line">	       -&gt; 再然后,我们的dns服务器就会去请求rootkit这个域的ns服务器</span><br><span class="line">		 -&gt; rootkit这个域的ns服务器一看是要访问www就直接找到了www对应的A记录的ip,并把它丢给我们的dns,上面逐个询问的过程,即 `迭代查询`</span><br><span class="line">		   -&gt; 最后,我们的dns再把最终解析到的这个ip丢给我们的客户端,然后客户端就直接拿着去访问了,如下,访问google.com时的简易流程图</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p><img src="/img/dns101.jpg" alt=""><br>演示环境,此处暂以一主一从为例进行演示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DnsMaster	ip : 192.168.3.60	主 DNS 服务器</span><br><span class="line">DnsSlave	ip : 192.168.3.61	从 DNS 服务器</span><br></pre></td></tr></table></figure></p>
<p>0x02 几种常见的 DNS 功用类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主dns,主要负责实际的正反向域名解析</span><br><span class="line">从dns,主要从其它的主dns或者从dns中同步解析数据库,`即区域传送`,一般是通过序列号递增来判断主dns是否有更新</span><br><span class="line">缓存DNS服务器...</span><br><span class="line">转发器...</span><br></pre></td></tr></table></figure></p>
<p>0x03 理解DNS区域解析流向<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">正向 : FQDN -&gt; IP</span><br><span class="line">反向 : IP -&gt; FQDN</span><br><span class="line"></span><br><span class="line">FQDN 即 `完整合法域名`,如 `www.rootkit.org.` 最后面的`.`表示根,意思就是根下的org下的rootkit</span><br><span class="line">不管是正向还是反向区域都需要有一个单独的解析数据库去解析</span><br></pre></td></tr></table></figure></p>
<p>0x04 认识DNS中一些常见的资源记录类型,说到底就是用它们来标记某个主机类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A  	记录	FQDN -&gt; ipv4</span><br><span class="line">AAAA 	记录	FQDN -&gt; ipv6</span><br><span class="line">NS 	记录	标明当前区域的NS服务器是谁</span><br><span class="line">MX 	记录	标明当前域内谁是邮件服务器</span><br><span class="line">PTR 	记录	ip -&gt; FQDN</span><br><span class="line">SOA 	记录	一个解析库有且只有一个SOA记录,且必须为解析库的第一条记录</span><br><span class="line">CNAME	记录	别名</span><br></pre></td></tr></table></figure></p>
<p>0x05 如何在区域配置文件中定义上述各种资源记录</p>
<p>记录定义标准格式,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name TTL值[缓存时长可省] IN 记录类型 值</span><br></pre></td></tr></table></figure></p>
<p>定义SOA记录,一般会配合DNS主从同步来用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">admin.org.  IN SOA    ns.admin.org.    admin.admin.org. (</span><br><span class="line">			2017122309 	   ; 序列号</span><br><span class="line">			2H 		   ; 刷新时间</span><br><span class="line">			10M		   ; 重试时长</span><br><span class="line">			1W		   ; 过期时间</span><br><span class="line">			1D		   ; 否定答案的TTL值</span><br><span class="line">			)</span><br></pre></td></tr></table></figure></p>
<p>定义NS记录,如果连续两条紧挨着的记录相同,后面一个的name可省略,另外NS记录需要在后续有一个对应的A记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin.org.	IN 	NS	ns1.admin.org.</span><br><span class="line">admin.org.	IN 	NS	ns2.admin.org.</span><br></pre></td></tr></table></figure></p>
<p>定义MX记录,注意,此记录有优先级,数字越小,优先级越高,同样,后面也需要指向一条A记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin.org.	IN 	MX	10	mx1.admin.org.</span><br><span class="line">admin.org.	IN 	MX	6	mx2.admin.org.</span><br></pre></td></tr></table></figure></p>
<p>定义A记录,注意,对于A记录,同一个name可以对应多个不同的ip,访问时会自动实现轮询的效果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">www.admin.org.	  IN	A		l.2.3.4</span><br><span class="line">www.admin.org.	  IN	A		l.2.3.4</span><br><span class="line">*.admin.org.	  IN	A		1.2.3.4		泛解析,用户输入不存在的域名是全部都解析到这个ip上</span><br><span class="line">admin.org.	  IN	A		1.2.3.4		另外一种泛解析写法 admin.org</span><br></pre></td></tr></table></figure></p>
<p>定义PTR记录,即反向区域解析,一定要注意,所有的ip地址必须反过来写,另外,都必须带上固有后缀<code>in-addr.arpa.</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.3.2.in-addr.arpa.	IN	PTR	www.admin.org.</span><br></pre></td></tr></table></figure></p>
<p>定义CNAME记录,意思就是当访问web.admin.org.时就直接解析到<a href="http://www.admin.org" target="_blank" rel="noopener">www.admin.org</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web.admin.org.	  IN	CNAME	www.admin.org.</span><br></pre></td></tr></table></figure></p>
<p>0x06 关于一些常见 dns 解析测试工具的基本使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># dig -t 记录类型 要解析的域名 @用于解析该域名的dns服务器</span><br><span class="line"># dig -t axfr 要解析的域名 @用于解析该域名的dns服务器	  全量区域同步,可用来测试`区域传送漏洞`</span><br><span class="line"># dig +trace 要解析的域名  跟踪指定域名的详细解析过程</span><br><span class="line"># nslookup	交互式查询</span><br><span class="line"># host -t 类型 要解析的域名 用于解析的dns服务器</span><br></pre></td></tr></table></figure></p>
<p>0x07 因为后续还要做DNS主从实时同步,所以这里就先从<code>配置正向区域解析</code>开始</p>
<p>开始安装主DNS,bind是核心包,bind-devel是bind核心库,utils是dns测试工具包,工具包里包含了一些常用工具,如,nslookup,dig,host,另外,此处暂以yum方式进行安装,当然,你也可以自行采用源码编译的方式进行安装,不过编译安装不太好的地方就是,有很多关键目录和配置文件没法自动生成,配置起来比较繁琐<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install  bind-utils bind bind-devel bind-chroot -y</span><br><span class="line"># rpm -qa | grep bind</span><br></pre></td></tr></table></figure></p>
<p>配置主DNS的主配置文件<code>named.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"># cat /var/named/named.ca	全球13组根DNS服务器解析地址的存放位置</span><br><span class="line"># cp /etc/named.conf&#123;,.bak&#125;	先备份配置文件再编辑</span><br><span class="line"># &gt; /etc/named.conf		bind的主配置文件,主要提供全局配置</span><br><span class="line"># vi /etc/named.conf</span><br><span class="line"></span><br><span class="line">// 全局配置段,注意,dns工作在tcp/53和udp/53端口上,tcp/53一般主要用来进行区域同步,而udp/53主要用来负责正常的解析请求和响应</span><br><span class="line">options &#123;</span><br><span class="line">	version &quot;1.1.1&quot;;</span><br><span class="line">	listen-on port 53 &#123; 192.168.3.60;127.0.0.1; &#125;;	// 把dns端口监听在本地指定的ip上</span><br><span class="line">	directory &quot;/var/named/chroot/etc/&quot;;		</span><br><span class="line">	pid-file &quot;/var/named/chroot/var/run/named/named.pid&quot;;</span><br><span class="line">	allow-query &#123; any; &#125;;	// 允许任意主机向我进行dns请求</span><br><span class="line">	Dump-file &quot;/var/named/chroot/var/log/binddump.db&quot;;</span><br><span class="line">	Statistics-file &quot;/var/named/chroot/var/log/named_stats&quot;;</span><br><span class="line">	zone-statistics yes;</span><br><span class="line">	memstatistics-file &quot;log/mem_stats&quot;;</span><br><span class="line">	empty-zones-enable no;</span><br><span class="line">	forwarders &#123; 114.114.114.114;8.8.8.8; &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 设置rndc通信共享秘钥</span><br><span class="line">key &quot;rndc-key&quot; &#123; </span><br><span class="line">	algorithm hmac-md5;</span><br><span class="line">	secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">controls &#123;</span><br><span class="line">	inet 127.0.0.1 port 953</span><br><span class="line">	allow &#123; 127.0.0.1; &#125; keys &#123; &quot;rndc-key&quot;; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// bind日志配置区段	</span><br><span class="line">logging &#123;</span><br><span class="line">	channel warning &#123;</span><br><span class="line">		file &quot;/var/named/chroot/var/log/dns_warning&quot; versions 10 size 10m;</span><br><span class="line">		severity warning;</span><br><span class="line">		print-category yes;</span><br><span class="line">		print-severity yes;</span><br><span class="line">		print-time yes;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	channel general_dns &#123;</span><br><span class="line">		file &quot;/var/named/chroot/var/log/dns_log&quot; versions 10 size 100m;</span><br><span class="line">		severity info;</span><br><span class="line">		print-category yes;</span><br><span class="line">		print-severity yes;</span><br><span class="line">		print-time yes;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	category default &#123;</span><br><span class="line">		warning;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	category queries &#123;</span><br><span class="line">		general_dns;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 为了简化bind主配置文件,可以通过include的方式来引入区域文件</span><br><span class="line">include &quot;/var/named/chroot/etc/view.conf&quot;;</span><br></pre></td></tr></table></figure></p>
<p>针对rndc 的简单配置,关于rndc其实就是个bind服务管理工具,可以通过它在本地或者直接远程来方便的对bind服务进行各种管理操作,如,重载,刷新缓存,关闭…默认工作在tcp/953端口上,比较危险,所以我们一般只让它监听在本地即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/rndc.key</span><br><span class="line"></span><br><span class="line">key &quot;rndc-key&quot; &#123;</span><br><span class="line">    algorithm hmac-md5;</span><br><span class="line">    secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vi /etc/rndc.conf</span><br><span class="line"></span><br><span class="line">key &quot;rndc-key&quot; &#123;</span><br><span class="line">	algorithm hmac-md5;</span><br><span class="line">	secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">options &#123;</span><br><span class="line">	default-key &quot;rndc-key&quot;;</span><br><span class="line">	default-server 127.0.0.1;	// 让它只监听在本地,禁止rndc远程连接,防止被利用</span><br><span class="line">	default-port 953;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>0x08 定义正向区域文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/view.conf</span><br><span class="line"></span><br><span class="line">view &quot;MasterView&quot; &#123;</span><br><span class="line">	zone &quot;admin.org&quot; &#123;</span><br><span class="line">		type    master;</span><br><span class="line">		file    &quot;admin.org.zone&quot;;  // 区域文件名,此处的文件名可以随意</span><br><span class="line">		allow-transfer &#123;	   // 允许传送的主机,所谓的区域传送漏洞也就出在这里</span><br><span class="line">			192.168.3.61;</span><br><span class="line">			// any;		   // 如果此处设置为any,则允许任意主机来传送,这就是产生区域传送漏洞的根源</span><br><span class="line">					   // 所以务必谨记,跟谁传送,就只写谁的ip</span><br><span class="line">		&#125;;</span><br><span class="line">		notify  yes;</span><br><span class="line">		also-notify &#123;</span><br><span class="line">			192.168.3.61;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>0x09 定义正向区域文件,我们再来编写正向区域解析数据库,内部主要用于存放各种记录类型和宏,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/admin.org.zone</span><br><span class="line"></span><br><span class="line">$TTL 3600   ; 1h</span><br><span class="line">@     IN SOA  ns1.admin.org. email.admin.org (</span><br><span class="line">                        2003       ; serial   // 时刻谨记,每次如果是手工修改完解析库文件以后都要自增一下</span><br><span class="line">                        900        ; refresh (15 minutes)</span><br><span class="line">                        600        ; retry (10 minutes)</span><br><span class="line">                        86400      ; expire (1 day)</span><br><span class="line">                        3600       ; minimum (1 hour)</span><br><span class="line">                         )</span><br><span class="line">                IN      NS      ns1.admin.org.</span><br><span class="line">                IN      NS      ns2.admin.org.</span><br><span class="line">                IN      MX  10  mx1.admin.org.</span><br><span class="line">                IN      MX  20  mx2.admin.org.</span><br><span class="line">ns1		IN	A	192.168.3.3</span><br><span class="line">ns2		IN	A	192.168.3.61</span><br><span class="line">mx1		IN	A	192.168.3.4</span><br><span class="line">mx2		IN	A	192.168.3.5</span><br><span class="line">www		IN	A	192.168.3.6</span><br><span class="line">www		IN	A	192.168.3.3</span><br><span class="line">ftp		IN	CNAME	www.admin.org.</span><br><span class="line">*		IN	A	192.168.3.110	//此处,即为泛解析的两种书写方式</span><br><span class="line">admin.org.	IN	A	192.168.3.120</span><br><span class="line">cacti		IN	A	192.168.3.16</span><br><span class="line">zabbix		IN	A	192.168.3.18</span><br></pre></td></tr></table></figure></p>
<p>0x10 配置完正向区域解析库以后,我们就可以来重载服务,测试解析了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># named-checkconf 		此命令会自动检查bind主配置文件是否有语法错误</span><br><span class="line"># named-checkzone &quot;admin.org&quot; admin.org.zone	检查指定区域解析库文件是否有错误配置</span><br><span class="line"># ps -aux | grep named		我们看到bind默认是用named用户来运行的,我们改下区域解析库文件的权限</span><br><span class="line"># chmod 640 /var/named/chroot/etc/admin.org.zone</span><br><span class="line"># ll /var/named/chroot/etc/admin.org.zone</span><br><span class="line"># chown named.named /var/named/chroot/etc/admin.org.zone</span><br><span class="line"># /etc/init.d/named start	启动dns服务</span><br><span class="line"># /etc/init.d/named reload	重载dns服务</span><br><span class="line"># rndc reload			在dns服务启动的情况下,也可使用rndc来重载区域解析库</span><br><span class="line"># chkconfig named on		加入系统自启动</span><br><span class="line"># netstat -tulnp			看下端口有没正常起来</span><br><span class="line"># dig -t A www.admin.org @192.168.3.60</span><br><span class="line"># dig -t A mx2.admin.org @192.168.3.60</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/dns bind resolv.png" alt=""></p>
<p>0x11 在正向区域测试解析没有任何问题之后,我们再来看如何定义反向区域,注意,反向区域的ip地址要全部反写,即 <code>变化的区域不写,不变的区域反写</code>,此区域不需要MX和A记录,只需要PTR记录即可,另外,通常都是<code>先有正向解析再有反向解析</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.3.x =&gt; 3.168.192.in-addr.arpa</span><br><span class="line">192.168.x.x =&gt; 168.192.in-addr.arpa</span><br></pre></td></tr></table></figure></p>
<p>定义反向区域的方式很简单,先定义好反向区域文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/view.conf</span><br><span class="line"></span><br><span class="line">view &quot;MasterView&quot; &#123;</span><br><span class="line">    zone &quot;admin.org&quot; IN &#123;</span><br><span class="line">		type    master;</span><br><span class="line">		file    &quot;admin.org.zone&quot;;</span><br><span class="line">		allow-transfer &#123;</span><br><span class="line">			192.168.3.61;</span><br><span class="line">		&#125;;</span><br><span class="line">		notify  yes;</span><br><span class="line">		also-notify &#123;</span><br><span class="line">			192.168.3.61;</span><br><span class="line">		&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    zone &quot;3.168.192.in-addr.arpa&quot; IN &#123; // 一样要反写,此处就表示192.168.3.x这个网段</span><br><span class="line">		type	master;</span><br><span class="line">		file	&quot;192.168.3.zone&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>再来定义反向区域解析库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/192.168.3.zone</span><br><span class="line"></span><br><span class="line">$TTL 3600</span><br><span class="line">$ORIGIN 3.168.192.in-addr.arpa.</span><br><span class="line">@	IN 	SOA	ns1.admin.org.	login.admin.org. (</span><br><span class="line">					2001 // 时刻谨记,每次如果是手工修改完解析库文件以后都要自增一下</span><br><span class="line">					900</span><br><span class="line">					600</span><br><span class="line">					86400</span><br><span class="line">					3600</span><br><span class="line">					)</span><br><span class="line">	IN	NS		ns1.admin.org.</span><br><span class="line">	IN	NS		ns2.admin.org.</span><br><span class="line">6	IN	PTR		www.admin.org.</span><br><span class="line">5	IN	PTR		mx2.admin.org.</span><br><span class="line">4	IN	PTR		mx1.admin.org.</span><br><span class="line">61	IN	PTR		ns2.admin.org.	// 注意,这里必须要有一条ns记录指向我们后面的从DNS服务器</span><br><span class="line">3	IN	PTR		ns1.admin.org.</span><br><span class="line">31	IN	PTR		pop3.admin.org.</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># chmod 640 192.168.3.zone</span><br><span class="line"># chown :named 192.168.3.zone</span><br><span class="line"># named-checkconf</span><br><span class="line"># named-checkzone &quot;3.168.192.in-addr.arpa&quot; 192.168.3.zone	检查zone配置文件中是否有错误</span><br><span class="line"># ll /var/named/chroot/etc/</span><br><span class="line"># /etc/init.d/named reload</span><br><span class="line"># netstat -tulnp</span><br><span class="line"># host -t ptr 192.168.3.3 192.168.3.60</span><br><span class="line"># dig -x 192.168.3.4 @192.168.3.60</span><br></pre></td></tr></table></figure>
<p><img src="/img/dns reverse resolv.png" alt=""></p>
<p>0x12 当主DNS的正反向区域解析都没任何问题之后,我们开始来配置<code>主从DNS实时同步</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install  bind-utils bind bind-devel bind-chroot -y</span><br><span class="line"># rpm -qa  bind-utils bind bind-devel bind-chroot</span><br></pre></td></tr></table></figure></p>
<p>开始配置从DNS,其实,在这里跟配置主DNS并没有太大区别,还是先按上面主DNS的配置方式来一遍<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># &gt; /etc/named.conf</span><br><span class="line"># vi /etc/named.conf</span><br><span class="line">options &#123;</span><br><span class="line">	version &quot;1.1.1&quot;;</span><br><span class="line">	listen-on port 53 &#123; 192.168.3.61; 127.0.0.1; &#125;;</span><br><span class="line">	directory &quot;/var/named/chroot/etc/&quot;;</span><br><span class="line">	pid-file &quot;/var/named/chroot/var/run/named/named.pid&quot;;</span><br><span class="line">	allow-query &#123; any; &#125;;</span><br><span class="line">	Dump-file &quot;/var/named/chroot/var/log/binddump.db&quot;;</span><br><span class="line">	Statistics-file &quot;/var/named/chroot/var/log/named_stats&quot;;</span><br><span class="line">	zone-statistics yes;</span><br><span class="line">	memstatistics-file &quot;log/mem_stats&quot;;</span><br><span class="line">	empty-zones-enable no;</span><br><span class="line">	forwarders &#123; 114.114.114.114;8.8.8.8; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">key &quot;rndc-key&quot; &#123;</span><br><span class="line">	algorithm hmac-md5;</span><br><span class="line">	secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">controls &#123;</span><br><span class="line">	inet 127.0.0.1 port 953</span><br><span class="line">	allow &#123; 127.0.0.1; &#125; keys &#123; &quot;rndc-key&quot;; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">	</span><br><span class="line">logging &#123;</span><br><span class="line">	channel warning &#123;</span><br><span class="line">		file &quot;/var/named/chroot/var/log/dns_warning&quot; versions 10 size 10m;</span><br><span class="line">		severity warning;</span><br><span class="line">		print-category yes;</span><br><span class="line">		print-severity yes;</span><br><span class="line">		print-time yes;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	channel general_dns &#123;</span><br><span class="line">		file &quot;/var/named/chroot/var/log/dns_log&quot; versions 10 size 100m;</span><br><span class="line">		severity info;</span><br><span class="line">		print-category yes;</span><br><span class="line">		print-severity yes;</span><br><span class="line">		print-time yes;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	category default &#123;</span><br><span class="line">		warning;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	category queries &#123;</span><br><span class="line">		general_dns;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">include &quot;/var/named/chroot/etc/view.conf&quot;;</span><br></pre></td></tr></table></figure></p>
<p>配置rndc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/rndc.key</span><br><span class="line"></span><br><span class="line">key &quot;rndc-key&quot; &#123;</span><br><span class="line">    algorithm hmac-md5;</span><br><span class="line">    secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vi /etc/rndc.conf</span><br><span class="line"></span><br><span class="line">key &quot;rndc-key&quot; &#123;</span><br><span class="line">	algorithm hmac-md5;</span><br><span class="line">	secret &quot;Eqw4hClGExUWeDkKBX/pBg==&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">options &#123;</span><br><span class="line">	default-key &quot;rndc-key&quot;;</span><br><span class="line">	default-server 127.0.0.1;</span><br><span class="line">	default-port 953;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>0x13 接着,再来配置<code>主从DNS正向区域实时同步</code>,务必要记得在主DNS的正向解析库中一定要先有一条ns记录的ip是指向从DNS服务器的,不然同步通知是无法完成的,也就是说,一旦主DNS发生改变,它会通知所有的ns服务器进行更新,这样就可以实现实时正向区域同步的效果</p>
<p>对于从DNS的配置就非常简单了,只需要在从DNS上编辑区域文件,在里面配置好主DNS服务器的ip,设置好从DNS正向区域文件名,然后启动服务即可,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/view.conf</span><br><span class="line">view &quot;SlaveView&quot; &#123;</span><br><span class="line">    zone &quot;admin.org&quot; IN &#123;</span><br><span class="line">	type    slave;	// 这里的类型要选择从服务器</span><br><span class="line">	masters &#123; 192.168.3.60; &#125;;	// 指定主DNS服务器ip</span><br><span class="line">	file &quot;slave.admin.org.zone&quot;;	// 指定从DNS正向区域解析库文件名,重启服务后它会自动同步过来,不用手工编辑</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>上面配置没问题以后,我们来重载服务试试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ps -aux | grep named</span><br><span class="line"># cd /var/ &amp;&amp; chown named.named named/	为了能让它自动创建解析库文件需要改先权限</span><br><span class="line"># ll /var/named/chroot/etc</span><br><span class="line"># /etc/init.d/named start</span><br><span class="line"># chkconfig named on</span><br><span class="line"># cat /var/named/chroot/etc/slave.admin.org.zone	这个文件会在从dns重载之后自动被同步过来</span><br><span class="line"># netstat -tulnp</span><br><span class="line"># tail -f /var/log/messages		其实,从日志中我们是可以清晰的看到整个同步过程的</span><br><span class="line"># dig -t MX admin.org @192.168.3.61 	同步完成后,我们可以直接用本机来进行解析测试</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/dns MASTER MX.png" alt=""></p>
<p>正向区域实时同步搞定之后,我们再来看看如何实现<code>反向区域实时主从同步</code>,还是要先在主DNS上的反向区域解析库中定义一条指向从DNS服务器的PTR记录,如下</p>
<p>首先,到主DNS服务器上去编辑反向区域解析库文件,添加一条指向从DNS服务器的PTR记录,具体如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/192.168.3.zone</span><br><span class="line"></span><br><span class="line">$TTL 3600</span><br><span class="line">$ORIGIN 3.168.192.in-addr.arpa.</span><br><span class="line">@	IN 	SOA	ns1.admin.org.	login.admin.org. (</span><br><span class="line">					2001	// 时刻谨记,每次如果是手工修改完解析库文件以后都要自增一下</span><br><span class="line">					900</span><br><span class="line">					600</span><br><span class="line">					86400</span><br><span class="line">					3600</span><br><span class="line">					)</span><br><span class="line">	IN	NS		ns1.admin.org.</span><br><span class="line">	IN	NS		ns2.admin.org.</span><br><span class="line">6	IN	PTR		www.admin.org.</span><br><span class="line">5	IN	PTR		mx2.admin.org.</span><br><span class="line">4	IN	PTR		mx1.admin.org.</span><br><span class="line">61	IN	PTR		ns2.admin.org.	// 先在主DNS的反向区域解析库中添加一条指向从DNS的PTR记录</span><br><span class="line">3	IN	PTR		ns1.admin.org.</span><br><span class="line">31	IN	PTR		pop3.admin.org.</span><br></pre></td></tr></table></figure></p>
<p>之后,再回到从DNS服务器上编辑区域配置文件,添加一个反向区域,跟正向区域同步一样,依然是指明主DNS服务器ip和从DNS反向区域解析库文件名,之后再重载服务,测试解析即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># vi /var/named/chroot/etc/view.conf</span><br><span class="line"></span><br><span class="line">view &quot;SlaveView&quot; &#123;</span><br><span class="line">    zone &quot;admin.org&quot; IN &#123;</span><br><span class="line">		type    slave;</span><br><span class="line">		masters &#123; 192.168.3.60; &#125;;</span><br><span class="line">		file &quot;slave.admin.org.zone&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    zone &quot;3.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">		type slave;</span><br><span class="line">		masters &#123; 192.168.3.60;  &#125;;</span><br><span class="line">		file &quot;192.168.3.zone&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># rndc reload</span><br><span class="line"># cat /var/named/chroot/etc/192.168.3.zone	依然是在重载服务以后,该反向区域解析库文件会被自动同步过来</span><br><span class="line"># host -t ptr 192.168.3.3 192.168.3.61</span><br></pre></td></tr></table></figure>
<p><img src="/img/dns master ptr.png" alt=""></p>
<p>0x14 关于DNS自身的安全问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">配置错误,修复简单</span><br><span class="line">各类投毒污染攻击,需要多方配合,篇幅原因后续我们再详细说</span><br><span class="line">bind工具自身的漏洞,时常注意官方发布的各类高危补丁,尤其是可以直接被远程利用的,而后进行适时修补或更新即可</span><br></pre></td></tr></table></figure></p>
<p>0x15 基于 DNS 的各类渗透技巧,其实说来,底层的原理非常简单,因为在一些脚本或者数据库中有很多那种可以直接用于发起DNS请求的函数,而我们就可以通过此来构造自己的各种攻击语句,然后再从解析log中提取执行结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">基于DNS log的sql盲注,代码及命令执行...后续有空接着说</span><br><span class="line">基于DNS隧道的各类远程,如,cobalt strike,关于这个,我们后续还会再单独抽出来详细说</span><br><span class="line">更多,待续...</span><br></pre></td></tr></table></figure></p>
<p>下面就是个简单的区域传送效果,不过像这种古董级漏洞,现在确实已经非常罕见了,属于敏感信息泄露的一种,容易直接被人看见内部的网络结构拓扑部署,祝大家好运吧 ^_^</p>
<p><img src="/img/dns zone vluln.png" alt=""><br><br></p>
<p>后话:<br>&nbsp;&nbsp;&nbsp;&nbsp;其实,像dns这种过于的基础服务,配置起来确实非常简单,不过,关键还是要能灵活应用,非常建议大家还是把绝大部分的时间都花在去深入理解dns的解析过程上,个人觉得那个才是真正的价值,因为所有的DNS高级应用场景,最底层全部都是基于这个,把最基础的东西搞通透以后,再去看各类高级应用就非常简单了,还是那句话<code>不管上层怎么变化,但万变不离其宗</code>,篇幅限制,此处仅仅也只是先带大家打个照面,更多高级应用,后续肯定还会有大量的篇幅说明,来日方长,我们待续……</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://apt404.github.io/2017/12/12/Dns-tips/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://apt404.github.io/2017/12/12/Dns-tips/&text=DNS 深度理解 [ 一 ]"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://apt404.github.io/2017/12/12/Dns-tips/&is_video=false&description=DNS 深度理解 [ 一 ]"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DNS 深度理解 [ 一 ]&body=Check out this article: https://apt404.github.io/2017/12/12/Dns-tips/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://apt404.github.io/2017/12/12/Dns-tips/&title=DNS 深度理解 [ 一 ]"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://apt404.github.io/2017/12/12/Dns-tips/&name=DNS 深度理解 [ 一 ]&description=&lt;p&gt;0x01 首先,我们先来简单回顾下&lt;code&gt;DNS的基本解析流程&lt;/code&gt;, 比较简单,如下&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;-&amp;gt; 以客户端浏览器访问 www.rootkit.org 域名为例,首先,它会去检查当前浏览器缓存,如果有,就直接响应,如果没有,就继续往下找&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -&amp;gt; 接着,操作系统会去检查自己的host文件,如果从中没找到对应关系,会再到系统dns缓存中查,如果缓存中有,就直接返回该域名所对应的ip&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -&amp;gt; 如果缓存中没有,则会向我们事先设置好的dns服务器 [ 一般有两个, 主 &amp;amp; 备 ] 去请求,即所谓的`递归查询`,dns服务器首先会到自身解析数据库中去查&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      -&amp;gt; 如果dns服务器在自己的解析库中也没找到,它就会自动帮我们向根发送询问请求&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	-&amp;gt; 此时,根看到要请求的是org的后缀,就会把org所在的ns服务器告诉我们的dns&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	  -&amp;gt; 然后,我们的dns服务器就会去请求org所在的ns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	    -&amp;gt; 当请求到达org ns服务器时,org一看域名是在rootkit这个域下的,就会把rootkit所在的ns服务器再告诉我们的dns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	       -&amp;gt; 再然后,我们的dns服务器就会去请求rootkit这个域的ns服务器&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		 -&amp;gt; rootkit这个域的ns服务器一看是要访问www就直接找到了www对应的A记录的ip,并把它丢给我们的dns,上面逐个询问的过程,即 `迭代查询`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		   -&amp;gt; 最后,我们的dns再把最终解析到的这个ip丢给我们的客户端,然后客户端就直接拿着去访问了,如下,访问google.com时的简易流程图&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


