<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 利用最原始的 SSH key ,实现批量ssh管理 只适合较小规模集群场景,通常在100台机器以内,要实现的最终效果,如下:12可以批量分发文件,进行常规配置管理可以批量执行shell命令,进行日常维护操作 演示环境:123SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机SshKeySlave5	ip: 192.168.5.13	Ce">
<meta name="keywords" content="演练环境搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 Ssh Key 的分发安全">
<meta property="og:url" content="https://apt404.github.io/2017/07/08/ssh-key-mac/index.html">
<meta property="og:site_name" content="APT404-不疯不魔怎么活">
<meta property="og:description" content="0x01 利用最原始的 SSH key ,实现批量ssh管理 只适合较小规模集群场景,通常在100台机器以内,要实现的最终效果,如下:12可以批量分发文件,进行常规配置管理可以批量执行shell命令,进行日常维护操作 演示环境:123SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机SshKeySlave5	ip: 192.168.5.13	Ce">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-11-27T09:15:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于 Ssh Key 的分发安全">
<meta name="twitter:description" content="0x01 利用最原始的 SSH key ,实现批量ssh管理 只适合较小规模集群场景,通常在100台机器以内,要实现的最终效果,如下:12可以批量分发文件,进行常规配置管理可以批量执行shell命令,进行日常维护操作 演示环境:123SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机SshKeySlave5	ip: 192.168.5.13	Ce">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>基于 Ssh Key 的分发安全</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/07/09/nosql-redis/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/07/08/NFS-sec/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://apt404.github.io/2017/07/08/ssh-key-mac/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&text=基于 Ssh Key 的分发安全"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&is_video=false&description=基于 Ssh Key 的分发安全"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=基于 Ssh Key 的分发安全&body=Check out this article: https://apt404.github.io/2017/07/08/ssh-key-mac/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&name=基于 Ssh Key 的分发安全&description=&lt;p&gt;&lt;br&gt;&lt;br&gt;0x01 利用最原始的 SSH key ,实现批量ssh管理 &lt;code&gt;只适合较小规模集群场景,通常在100台机器以内&lt;/code&gt;,要实现的最终效果,如下:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;可以批量分发文件,进行常规配置管理&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;可以批量执行shell命令,进行日常维护操作&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;演示环境:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SshKeySlave5	ip: 192.168.5.13	CentOS5.5 i386   分发客户机&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SshKeySlave7	ip: 192.168.5.12	CentOS7	  x86_64 分发客户机&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;0x02 基于SSH key 的批量ssh管理,具体实现过程:&lt;/p&gt;
&lt;p&gt;以下是在这方面已经相对比较成熟的一些工具框架,后续会再专门针对每一种进行单独说明:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;saltstack,ansible,puppet...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# rpm -qa openssh openssl 务必确保所有机器均已事先安装好ssh且ssh服务已正常开启&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x03 先在所有机器上 &lt;code&gt;[ 注意,是所有机器,密码完全一致 ]&lt;/code&gt;创建一个普通用户,因为等会儿我们要用此用户身份来进行各种分发操作&lt;/p&gt;
&lt;p&gt;&lt;code&gt;切记,严禁直接用root分发,权限过高,太危险,分发机一旦被攻陷,其它的分发客户机也就随之沦陷了,建议,如果实在有需求可以用sudo或suid [其实也不推荐]来暂时性授权&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# useradd sysadm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# echo &amp;quot;admin&amp;quot; | passwd --stdin sysadm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x04 再在分发机上创建好密钥对,准备发到各个客户机上&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# su - sysadm		切到刚刚创建的用户下&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ ssh-keygen -t dsa	一路回车即可&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ ls -l .ssh/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -rw------- 1 sysadm sysadm 668 Nov 27 14:11 id_dsa	 私钥[钥匙]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -rw-r--r-- 1 sysadm sysadm 609 Nov 27 14:11 id_dsa.pub 公钥[锁],把公钥分发给所有要ssh的机器&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        基于 Ssh Key 的分发安全
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">klion</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-07-08T01:35:04.000Z" itemprop="datePublished">2017-07-08</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/演练环境搭建/">演练环境搭建</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><br><br>0x01 利用最原始的 SSH key ,实现批量ssh管理 <code>只适合较小规模集群场景,通常在100台机器以内</code>,要实现的最终效果,如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以批量分发文件,进行常规配置管理</span><br><span class="line">可以批量执行shell命令,进行日常维护操作</span><br></pre></td></tr></table></figure></p>
<p>演示环境:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机</span><br><span class="line">SshKeySlave5	ip: 192.168.5.13	CentOS5.5 i386   分发客户机</span><br><span class="line">SshKeySlave7	ip: 192.168.5.12	CentOS7	  x86_64 分发客户机</span><br></pre></td></tr></table></figure></p>
<p>0x02 基于SSH key 的批量ssh管理,具体实现过程:</p>
<p>以下是在这方面已经相对比较成熟的一些工具框架,后续会再专门针对每一种进行单独说明:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">saltstack,ansible,puppet...</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qa openssh openssl 务必确保所有机器均已事先安装好ssh且ssh服务已正常开启</span><br></pre></td></tr></table></figure>
<p>0x03 先在所有机器上 <code>[ 注意,是所有机器,密码完全一致 ]</code>创建一个普通用户,因为等会儿我们要用此用户身份来进行各种分发操作</p>
<p><code>切记,严禁直接用root分发,权限过高,太危险,分发机一旦被攻陷,其它的分发客户机也就随之沦陷了,建议,如果实在有需求可以用sudo或suid [其实也不推荐]来暂时性授权</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># useradd sysadm</span><br><span class="line"># echo &quot;admin&quot; | passwd --stdin sysadm</span><br></pre></td></tr></table></figure>
<p>0x04 再在分发机上创建好密钥对,准备发到各个客户机上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># su - sysadm		切到刚刚创建的用户下</span><br><span class="line">$ ssh-keygen -t dsa	一路回车即可</span><br><span class="line">$ ls -l .ssh/</span><br><span class="line">  -rw------- 1 sysadm sysadm 668 Nov 27 14:11 id_dsa	 私钥[钥匙]</span><br><span class="line">  -rw-r--r-- 1 sysadm sysadm 609 Nov 27 14:11 id_dsa.pub 公钥[锁],把公钥分发给所有要ssh的机器</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>0x05 最后,批量往所有分发客户机上发送刚刚创建好的公钥<code>把锁丢给别人,钥匙自己拿着</code>, 在初次部署,机器比较多的情况下,也可利用expect的方式进行发送<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id -i ~/.ssh/id_dsa.pub &quot;-p 22 sysadm@192.168.5.12&quot;</span><br><span class="line">$ ssh -p 22 sysadm@192.168.5.12		现在即可无密码ssh登陆</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id -i ~/.ssh/id_dsa.pub &quot;-p 22 sysadm@192.168.5.13&quot;</span><br><span class="line">$ ssh -p 22 sysadm@192.168.5.13</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls .ssh/authorized_keys  这是实际到目标机器上的文件名,只不过过去的时候被改名了,其实跟id_dsa.pub文件中的内容是一模一样的,权限600</span><br></pre></td></tr></table></figure>
<p>0x06 尝试在远程机器上执行shell命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -p22 sysadm@192.168.5.12 hostname</span><br><span class="line">$ ssh -p22 sysadm@192.168.5.13 hostname</span><br></pre></td></tr></table></figure></p>
<p>0x07 尝试批量往远程机器上分发文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P22 -p -r /etc/hosts sysadm@192.168.5.12:~   直接往对方sysadm用户的家目录下发</span><br><span class="line">$ scp -P22 -p -r /etc/hosts sysadm@192.168.5.13:~</span><br></pre></td></tr></table></figure></p>
<p>0x08 通过脚本进行批量文件分发及shell命令执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /bin/sh send_file.sh /etc/hosts</span><br><span class="line">$ /bin/sh send_file.sh ./send_dir/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">########################## 批量分发文件 ###############################</span><br><span class="line">#!/bin/bash</span><br><span class="line"># use: ssh key commond / file </span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">    echo &quot;use: sh ssh_key.sh file | dir&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">for n in 12 13</span><br><span class="line">do</span><br><span class="line">    scp -P22 -p -r $1 sysadm@192.168.5.$n:~ &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo -e &quot;$n send ok \n&quot;</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;$n ,Oh No,send failed \n&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /bin/sh send_cmd.sh &quot;rm -fr /home/sysadm/send_dir&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">########################## 批量执行shell命令 ###############################</span><br><span class="line">#!/bin/bash</span><br><span class="line"># use: ssh key commond / file </span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">    echo &quot;use: sh ssh_cmd.sh cmd&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">	</span><br><span class="line">for n in 12 13</span><br><span class="line">do</span><br><span class="line">    echo -e &quot;\n-----------------------------------------------------------------------&quot;</span><br><span class="line">    ssh -p22 sysadm@192.168.5.$n $1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>0x09 除了分发文件,执行命令,我们也可以尝试利用ssh key 实现免密码rsync数据同步,不过实际基本不会这么做,太危险,因为ssh key同样也可以执行命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rsync -avzP -e &apos;ssh -p 22&apos; /tmp/ sysadm@192.168.5.4:/tmp/</span><br></pre></td></tr></table></figure></p>
<p>0x10 分发过程中需要注意的一些的问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">严禁用root的ssh key进行各种分发操作,非常危险,分发机一旦被攻陷,其它的机器也就跟着沦陷了</span><br><span class="line">让普通用户使用sudo来执行特权操作,还是有些危险</span><br><span class="line">也可以用suid来控制,对要执行的命令进行suid,实际中也最好不要用,比较危险</span><br><span class="line">推荐使用各种第三方工具,如,puppet,saltstack</span><br></pre></td></tr></table></figure></p>
<p>0x11 利用sudo的方式批量执行shell命令,到所有分发机客户机上对sysadm用户添加特权命令,具体操作如下,实际中把上面的稍微改下即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># echo &quot;sysadm  ALL=(ALL) NOPASSWD:/usr/bin/rsync&quot; &gt;&gt; /etc/sudoers </span><br><span class="line"># visudo -c</span><br><span class="line"># grep sysadm /etc/sudoers</span><br></pre></td></tr></table></figure></p>
<p>脚本意思就是先把修改好的系统配置文件推到远程机器上的sysadm家目录下,再用sudo来执行特权操作,说实话,既然都可以操作系统配置文件了,创建个用户又有多难呢,所以,自己觉得这样也并不是特别安全<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /bin/sh send_sudo_file.sh hosts /etc/</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">########################## 利用sudo 来分发文件,执行命令  ###############################</span><br><span class="line">#!/bin/bash</span><br><span class="line"># use: ssh key commond / file </span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">    echo &quot;use: sh ssh_sudo_file.sh localfile remotedir&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">	</span><br><span class="line">for n in 12 13</span><br><span class="line">do</span><br><span class="line">    scp -P22 -r -p $1 sysadm@192.168.5.$n:~ &amp;&gt;/dev/null &amp;&amp; \</span><br><span class="line">    ssh -t sysadm@192.168.5.$n sudo rsync $1 $2 &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">	echo -e &quot;$n exec ok !\n&quot;</span><br><span class="line">    else</span><br><span class="line">	echo -e &quot;$n , Oh No ,exec failed! &quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>0x12 至于如何利用suid 进行分发,就更简单了,只需要把你经常要用的一些命令加上suid权限属性就好了,如,我们前面用过的rsync,其实,个人觉得这样等于说就是帮别人留了个后门,上来以后,只需要find下当前系统中所有的suid,一下就能看到rsync,接着再把自己在本地修改好的系统配置文件直接传上来覆盖,后果你懂的,完全通过配置文件就可以创建一个root用户,根本不需要任何命令工具,这就是linux一切皆文件的好处,如果真想用,稍微改下脚本就好了,还是那句话,如果是自己手里的服务器最好还是不要这样搞<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chmod 4755 /usr/bin/rsync	让rsync具有suid属性</span><br><span class="line"># ls -l /usr/bin/rsync</span><br></pre></td></tr></table></figure></p>
<p>0x13 最后,利用定时任务执行各种分发任务即可,比较简单,此处就不细说了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># crontab -e</span><br></pre></td></tr></table></figure></p>
<p>0x14 分发机自身的安全问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">严禁直接把分发机暴露在公网中</span><br><span class="line">只允许特定的跳板机才能访问到分发机</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><br><br>小结:<br>&nbsp;&nbsp;&nbsp;&nbsp;关于分发安全,大致就先说到这里,个人还是更推荐直接用saltstack这类的工具来管理,没完,待续……</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://apt404.github.io/2017/07/08/ssh-key-mac/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&text=基于 Ssh Key 的分发安全"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&is_video=false&description=基于 Ssh Key 的分发安全"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=基于 Ssh Key 的分发安全&body=Check out this article: https://apt404.github.io/2017/07/08/ssh-key-mac/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&title=基于 Ssh Key 的分发安全"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://apt404.github.io/2017/07/08/ssh-key-mac/&name=基于 Ssh Key 的分发安全&description=&lt;p&gt;&lt;br&gt;&lt;br&gt;0x01 利用最原始的 SSH key ,实现批量ssh管理 &lt;code&gt;只适合较小规模集群场景,通常在100台机器以内&lt;/code&gt;,要实现的最终效果,如下:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;可以批量分发文件,进行常规配置管理&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;可以批量执行shell命令,进行日常维护操作&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;演示环境:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;SshKeyMaster 	ip: 192.168.5.11	CentOS6.8 x86_64 分发机&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SshKeySlave5	ip: 192.168.5.13	CentOS5.5 i386   分发客户机&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SshKeySlave7	ip: 192.168.5.12	CentOS7	  x86_64 分发客户机&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;0x02 基于SSH key 的批量ssh管理,具体实现过程:&lt;/p&gt;
&lt;p&gt;以下是在这方面已经相对比较成熟的一些工具框架,后续会再专门针对每一种进行单独说明:&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;saltstack,ansible,puppet...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# rpm -qa openssh openssl 务必确保所有机器均已事先安装好ssh且ssh服务已正常开启&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x03 先在所有机器上 &lt;code&gt;[ 注意,是所有机器,密码完全一致 ]&lt;/code&gt;创建一个普通用户,因为等会儿我们要用此用户身份来进行各种分发操作&lt;/p&gt;
&lt;p&gt;&lt;code&gt;切记,严禁直接用root分发,权限过高,太危险,分发机一旦被攻陷,其它的分发客户机也就随之沦陷了,建议,如果实在有需求可以用sudo或suid [其实也不推荐]来暂时性授权&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# useradd sysadm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# echo &amp;quot;admin&amp;quot; | passwd --stdin sysadm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x04 再在分发机上创建好密钥对,准备发到各个客户机上&lt;br&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# su - sysadm		切到刚刚创建的用户下&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ ssh-keygen -t dsa	一路回车即可&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ ls -l .ssh/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -rw------- 1 sysadm sysadm 668 Nov 27 14:11 id_dsa	 私钥[钥匙]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  -rw-r--r-- 1 sysadm sysadm 609 Nov 27 14:11 id_dsa.pub 公钥[锁],把公钥分发给所有要ssh的机器&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


